import { ICruiseSearchResponse, IItinerary, ISailing, IRoom } from "./cruise-search";

export interface IReducerOptions {
    metacode: string;
}

export interface IItinerarySailing {
    sailing: ISailing;
    itinerary: IItinerary;
    room: IRoom;
}

interface IDurationToItineraries {
    [key: string]: IItinerarySailing[]
}

export function reduceResultsTest(): IItinerarySailing[] {
    var response: any = { "filters": { "dest": ["BH"], "dur": [], "durDays": null, "ev": [], "specials": [], "port": ["MIA"], "ptPort": [], "ship": ["VI"], "numAdults": 2, "rateCode": [], "numChildren": 0, "senior": false, "military": false, "vifp": "", "tgo": null, "stateCode": "", "priceRange": null, "datFrom": "022018", "datTo": "022018", "excludeResults": false, "pageNumber": 1, "pageSize": 8, "sort": "FromPrice", "useSuggestions": true, "itin": null }, "searchStrategy": "default", "options": { "dest": [{ "code": "A", "label": "Alaska", "enabled": false }, { "code": "BH", "label": "The Bahamas", "enabled": true }, { "code": "BM", "label": "Bermuda", "enabled": false }, { "code": "NN", "label": "Canada & New England", "enabled": false }, { "code": "C", "label": "Caribbean", "enabled": true }, { "code": "E", "label": "Europe", "enabled": false }, { "code": "H", "label": "Hawaii", "enabled": false }, { "code": "M", "label": "Mexico", "enabled": false }, { "code": "T", "label": "Panama Canal", "enabled": false }, { "code": "ET", "label": "Transatlantic", "enabled": false }], "port": [{ "sort": 0, "isPopular": true, "code": "BWI", "label": "Baltimore, MD", "enabled": false }, { "sort": 1, "isPopular": true, "code": "CHS", "label": "Charleston, SC", "enabled": false }, { "sort": 2, "isPopular": true, "code": "FLL", "label": "Fort Lauderdale, FL", "enabled": false }, { "sort": 3, "isPopular": true, "code": "GAL", "label": "Galveston, TX", "enabled": false }, { "sort": 4, "isPopular": true, "code": "JAX", "label": "Jacksonville, FL", "enabled": false }, { "sort": 5, "isPopular": true, "code": "LAX", "label": "Long Beach (Los Angeles), CA", "enabled": false }, { "sort": 6, "isPopular": true, "code": "MIA", "label": "Miami, FL", "enabled": true }, { "sort": 7, "isPopular": true, "code": "MSY", "label": "New Orleans, LA", "enabled": false }, { "sort": 8, "isPopular": true, "code": "PCV", "label": "Port Canaveral (Orlando), FL", "enabled": false }, { "sort": 9, "isPopular": true, "code": "TPA", "label": "Tampa, FL", "enabled": false }, { "sort": 0, "isPopular": false, "code": "BDS", "label": "Barbados", "enabled": false }, { "sort": 1, "isPopular": false, "code": "BCN", "label": "Barcelona, Spain", "enabled": false }, { "sort": 2, "isPopular": false, "code": "HNL", "label": "Honolulu, HI", "enabled": false }, { "sort": 3, "isPopular": false, "code": "MOB", "label": "Mobile, AL", "enabled": false }, { "sort": 4, "isPopular": false, "code": "NYC", "label": "New York, NY", "enabled": false }, { "sort": 5, "isPopular": false, "code": "ORF", "label": "Norfolk, VA", "enabled": false }, { "sort": 6, "isPopular": false, "code": "SJU", "label": "San Juan, Puerto Rico", "enabled": false }, { "sort": 7, "isPopular": false, "code": "SEA", "label": "Seattle, WA", "enabled": false }, { "sort": 8, "isPopular": false, "code": "YVR", "label": "Vancouver, BC, Canada", "enabled": false }], "ptPort": [], "dur": [{ "code": "D1", "label": "2 - 5 Days", "enabled": true }, { "code": "D2", "label": "6 - 9 Days", "enabled": false }, { "code": "D3", "label": "10+ Days", "enabled": false }], "shipCode": [{ "code": "BR", "label": "Carnival Breeze", "enabled": false }, { "code": "CQ", "label": "Carnival Conquest", "enabled": false }, { "code": "DR", "label": "Carnival Dream", "enabled": false }, { "code": "EC", "label": "Carnival Ecstasy", "enabled": false }, { "code": "EL", "label": "Carnival Elation", "enabled": false }, { "code": "FA", "label": "Carnival Fantasy", "enabled": false }, { "code": "FS", "label": "Carnival Fascination", "enabled": false }, { "code": "FD", "label": "Carnival Freedom", "enabled": false }, { "code": "GL", "label": "Carnival Glory", "enabled": false }, { "code": "HZ", "label": "Carnival Horizon", "enabled": false }, { "code": "IM", "label": "Carnival Imagination", "enabled": false }, { "code": "IS", "label": "Carnival Inspiration", "enabled": false }, { "code": "LE", "label": "Carnival Legend", "enabled": false }, { "code": "LI", "label": "Carnival Liberty", "enabled": false }, { "code": "MC", "label": "Carnival Magic", "enabled": false }, { "code": "MI", "label": "Carnival Miracle", "enabled": false }, { "code": "PA", "label": "Carnival Paradise", "enabled": false }, { "code": "PR", "label": "Carnival Pride", "enabled": false }, { "code": "SE", "label": "Carnival Sensation", "enabled": false }, { "code": "SL", "label": "Carnival Splendor", "enabled": false }, { "code": "SH", "label": "Carnival Sunshine", "enabled": false }, { "code": "TI", "label": "Carnival Triumph", "enabled": false }, { "code": "VA", "label": "Carnival Valor", "enabled": false }, { "code": "VI", "label": "Carnival Victory", "enabled": true }, { "code": "VS", "label": "Carnival Vista", "enabled": false }], "ev": [{ "code": "CUW", "label": "Carrie Underwood", "enabled": false }, { "code": "JLO", "label": "Jay Leno", "enabled": false }, { "code": "JFX", "label": "Jeff Foxworthy", "enabled": false }, { "code": "LBT", "label": "Little Big Town", "enabled": false }], "specials": [{ "code": "J", "label": "All Carnival Journeys Sailings", "enabled": false }], "datFrom": [{ "code": "012017", "label": "Jan 2017", "enabled": true }, { "code": "022017", "label": "Feb 2017", "enabled": true }, { "code": "032017", "label": "Mar 2017", "enabled": true }, { "code": "042017", "label": "Apr 2017", "enabled": true }, { "code": "052017", "label": "May 2017", "enabled": true }, { "code": "062017", "label": "Jun 2017", "enabled": true }, { "code": "072017", "label": "Jul 2017", "enabled": true }, { "code": "082017", "label": "Aug 2017", "enabled": true }, { "code": "092017", "label": "Sep 2017", "enabled": true }, { "code": "102017", "label": "Oct 2017", "enabled": true }, { "code": "112017", "label": "Nov 2017", "enabled": true }, { "code": "122017", "label": "Dec 2017", "enabled": true }, { "code": "012018", "label": "Jan 2018", "enabled": true }, { "code": "022018", "label": "Feb 2018", "enabled": true }, { "code": "032018", "label": "Mar 2018", "enabled": true }, { "code": "042018", "label": "Apr 2018", "enabled": true }, { "code": "052018", "label": "May 2018", "enabled": true }, { "code": "062018", "label": "Jun 2018", "enabled": true }, { "code": "072018", "label": "Jul 2018", "enabled": true }, { "code": "082018", "label": "Aug 2018", "enabled": true }, { "code": "092018", "label": "Sep 2018", "enabled": true }, { "code": "102018", "label": "Oct 2018", "enabled": true }, { "code": "112018", "label": "Nov 2018", "enabled": true }, { "code": "122018", "label": "Dec 2018", "enabled": true }, { "code": "012019", "label": "Jan 2019", "enabled": true }, { "code": "022019", "label": "Feb 2019", "enabled": true }, { "code": "032019", "label": "Mar 2019", "enabled": true }, { "code": "042019", "label": "Apr 2019", "enabled": true }], "sort": [{ "code": "FromPrice", "label": "Price: Low to High", "enabled": true }, { "code": "FromPrice Desc", "label": "Price: High to Low", "enabled": true }, { "code": "DurationDays", "label": "Cruise Length: Short to Long", "enabled": true }, { "code": "DeparturePortName", "label": "Departure Port", "enabled": true }] }, "results": { "currentPage": 1, "lastPage": 1, "minPrice": 200.00, "maxPrice": 300.00, "totalResults": 2, "itineraries": [{ "id": "BAD_MIA_VI_3_Fri", "departurePortName": "Miami, FL", "regionName": "The Bahamas", "regionCode": "BH", "dur": 3, "shipName": "Carnival Victory", "shipCode": "VI", "image": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-nassau-3.jpg?useCustomFunctions=1&centerCrop=1&&w=1400&h=430", "imageSquare": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-nassau-3.jpg?useCustomFunctions=1&centerCrop=1&&w=700&h=430", "imageByLine": null, "itineraryURL": "/itinerary/3-day-the-bahamas-cruise/miami/victory/3-days/bad/?Military=N&PastGuest=N&Senior=N", "roundtrip": true, "deals": [], "carnivalLive": null, "specialScoops": [], "leadSailing": { "fromPrice": 219.0, "departureDate": "2018-02-23T05:00:00.000Z", "arrivalDate": "2018-02-26T05:00:00.000Z", "leadMetaCode": "IS" }, "ports": [{ "code": "NAS", "label": "Nassau, The Bahamas", "days": 0, "image": { "url": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-nassau-3.jpg?useCustomFunctions=1&centerCrop=1&&w=800&h=430", "altText": "beautiful blue skies and water in nassau bahamas" } }], "portsToDisplay": ["Miami", "Overnight Nassau"], "sailings": [{ "departureDate": "2018-02-16T05:00:00.000Z", "arrivalDate": "2018-02-19T05:00:00.000Z", "sailingURL": "/BookingEngine/Booking/Book?embkCode=MIA&itinCode=BAD&durDays=3&shipCode=VI&subRegionCode=BH&sailDate=02162018&sailingID=75810&numGuests=2&showDbl=False&isOver55=N&isPastGuest=N&stateCode=&isMilitary=N&evsel=", "rooms": { "interior": { "metacode": "IS", "price": 259.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "oceanview": { "metacode": "OS", "price": 319.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "balcony": { "metacode": "OB", "price": 419.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "suite": { "metacode": "SU", "price": 619.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" } }, "taxesAndFeesForLowestPrice": 96.81, "sailingId": "75810" }, { "departureDate": "2018-02-23T05:00:00.000Z", "arrivalDate": "2018-02-26T05:00:00.000Z", "sailingURL": "/BookingEngine/Booking/Book?embkCode=MIA&itinCode=BAD&durDays=3&shipCode=VI&subRegionCode=BH&sailDate=02232018&sailingID=75816&numGuests=2&showDbl=False&isOver55=N&isPastGuest=N&stateCode=&isMilitary=N&evsel=", "rooms": { "interior": { "metacode": "IS", "price": 219.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "oceanview": { "metacode": "OS", "price": 269.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "balcony": { "metacode": "OB", "price": 349.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "suite": { "metacode": "SU", "price": 559.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" } }, "taxesAndFeesForLowestPrice": 96.81, "sailingId": "75816" }], "stateroomMetaInformation": [{ "metacode": "IS", "title": "Interior", "description": "An Interior stateroom is the most affordable way to cruise, and Carnival Victory's interiors are not just cozy, but are full of things you&rsquo;d expect from any Carnival stateroom: a full private bathroom, Carnival Comfort Collection linens and just-a-call-away 24-hour room service.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIISN.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIISN-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIISN" }, { "metacode": "OS", "title": "Ocean View", "description": "Catch a glimpse of what's going by from your Ocean View stateroom aboard Carnival Victory, where you'll get views you won't find anywhere on land. Don't miss sunrise and sunset at sea — your comfy stateroom is the best way to experience these!", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIOSN.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIOSN-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIOSN" }, { "metacode": "OB", "title": "Balcony", "description": "Balcony staterooms were designed for maximum sea breeze and the most stunning views, so look to a balcony if you're looking to cruise aboard Carnival Victory. Any time you're in your room, you're just steps away from your own personal outdoor oasis, featuring the sort of sea view you can also feel.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIOBNB.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIOBNB-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIOBNB" }, { "metacode": "SU", "title": "Ocean Suite", "description": "A Carnival Victory suite is the ultimate way to cruise. With more space for stretching out indoors, plus a large balcony for kicking back outdoors, try an Ocean Suite to experience private, luxurious relaxation. Ocean Suites also include VIP check-in, walk-in closet and bathroom with whirlpool.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VISUNL.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VISUNL-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VISUNL" }], "hasVifpRates": false, "imageRandomizationInformation": { "crop": "Center", "metatag_sourceitem": "carnival-the-bahamas-port-nassau-3", "photocredit": "Nassau" }, "hasExtraValue": true }, { "id": "BA0_MIA_VI_4_Mon", "departurePortName": "Miami, FL", "regionName": "The Bahamas", "regionCode": "BH", "dur": 4, "shipName": "Carnival Victory", "shipCode": "VI", "image": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-half-moon-cay-3.jpg?useCustomFunctions=1&centerCrop=1&&w=1400&h=430", "imageSquare": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-half-moon-cay-3.jpg?useCustomFunctions=1&centerCrop=1&&w=700&h=430", "imageByLine": null, "itineraryURL": "/itinerary/4-day-the-bahamas-cruise/miami/victory/4-days/ba0/?Military=N&PastGuest=N&Senior=N", "roundtrip": true, "deals": [], "carnivalLive": null, "specialScoops": [], "leadSailing": { "fromPrice": 249.0, "departureDate": "2018-02-26T05:00:00.000Z", "arrivalDate": "2018-03-02T05:00:00.000Z", "leadMetaCode": "IS" }, "ports": [{ "code": "HMC", "label": "Half Moon Cay, The Bahamas", "days": 0, "image": { "url": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-half-moon-cay-3.jpg?useCustomFunctions=1&centerCrop=1&&w=800&h=430", "altText": "scenic ocean view of half moon cay" } }, { "code": "NAS", "label": "Nassau, The Bahamas", "days": 0, "image": { "url": "/~/media/Images/explore/destinations/ports/carnival-bahamas-port-nassau-3.jpg?useCustomFunctions=1&centerCrop=1&&w=800&h=430", "altText": "beautiful blue skies and water in nassau bahamas" } }], "portsToDisplay": ["Miami", "Half Moon Cay", "Nassau"], "sailings": [{ "departureDate": "2018-02-26T05:00:00.000Z", "arrivalDate": "2018-03-02T05:00:00.000Z", "sailingURL": "/BookingEngine/Booking/Book?embkCode=MIA&itinCode=BA0&durDays=4&shipCode=VI&subRegionCode=BH&sailDate=02262018&sailingID=78708&numGuests=2&showDbl=False&isOver55=N&isPastGuest=N&stateCode=&isMilitary=N&evsel=", "rooms": { "interior": { "metacode": "IS", "price": 249.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "oceanview": { "metacode": "OS", "price": 309.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "balcony": { "metacode": "OB", "price": 409.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" }, "suite": { "metacode": "SU", "price": 629.00, "rateAttributes": ["Reduced deposits starting from $50 per person", "Choose your room location", "Price protection", "Sale ends January 31, 2017"], "rateDescription": null, "extraSavingsType": "extra", "soldOut": false, "rateCode": "PEG" } }, "taxesAndFeesForLowestPrice": 96.87, "sailingId": "78708" }], "stateroomMetaInformation": [{ "metacode": "IS", "title": "Interior", "description": "An Interior stateroom is the most affordable way to cruise, and Carnival Victory's interiors are not just cozy, but are full of things you&rsquo;d expect from any Carnival stateroom: a full private bathroom, Carnival Comfort Collection linens and just-a-call-away 24-hour room service.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIISN.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIISN-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIISN" }, { "metacode": "OS", "title": "Ocean View", "description": "Catch a glimpse of what's going by from your Ocean View stateroom aboard Carnival Victory, where you'll get views you won't find anywhere on land. Don't miss sunrise and sunset at sea — your comfy stateroom is the best way to experience these!", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIOSN.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIOSN-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIOSN" }, { "metacode": "OB", "title": "Balcony", "description": "Balcony staterooms were designed for maximum sea breeze and the most stunning views, so look to a balcony if you're looking to cruise aboard Carnival Victory. Any time you're in your room, you're just steps away from your own personal outdoor oasis, featuring the sort of sea view you can also feel.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VIOBNB.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VIOBNB-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VIOBNB" }, { "metacode": "SU", "title": "Ocean Suite", "description": "A Carnival Victory suite is the ultimate way to cruise. With more space for stretching out indoors, plus a large balcony for kicking back outdoors, try an Ocean Suite to experience private, luxurious relaxation. Ocean Suites also include VIP check-in, walk-in closet and bathroom with whirlpool.", "images": ["/~/media/Images/Ships/VI/StateRoomCodes/VISUNL.jpg", "/~/media/Images/Ships/VI/StateRoomCodes/VISUNL-fl.jpg"], "isavailable": true, "metatag_sourceitem": "VISUNL" }], "hasVifpRates": false, "imageRandomizationInformation": { "crop": "Center", "metatag_sourceitem": "carnival-the-bahamas-port-half-moon-cay-3", "photocredit": "Half Moon Cay" }, "hasExtraValue": true }], "hst": "EB31", "hstTimestampUtc": "01/26/2017 22:18:33 +00:00" }, "specialRateQualifiers": { "vifp": true, "military": true, "senior": true, "resident": true } };

    return reduceResults(response, { metacode: "SU" });
}

export function reduceResults(response: ICruiseSearchResponse, options: IReducerOptions): IItinerarySailing[] {
    var durationToItineraries: IDurationToItineraries = {};
    for (let i = 0; i < response.results.itineraries.length; i++) {
        const itin = response.results.itineraries[i];
        const dur = itin.dur + "";
        if (!durationToItineraries[dur]) {
            durationToItineraries[dur] = [];
        }
        const cheapestSailing: IItinerarySailing = findCheapestItinerarySailing(options.metacode, itin);
        durationToItineraries[dur].push(cheapestSailing);
    }

    //4: [{Sailing, Room, Itinerary}, {Sailing, Room, Itinerary}, {Sailing, Room, Itinerary}]

    const cheapestSailingsByDuration: IItinerarySailing[] = [];
    for (let key in durationToItineraries) {
        if (durationToItineraries.hasOwnProperty(key)) {
            let itineraries: IItinerarySailing[] = durationToItineraries[key];
            itineraries.sort((lhs: IItinerarySailing, rhs: IItinerarySailing) => lhs.room.price - rhs.room.price);
            cheapestSailingsByDuration.push(itineraries[0]);
        }
    }

    if (cheapestSailingsByDuration.length <= 3) {
        return cheapestSailingsByDuration;
    }

    const first = cheapestSailingsByDuration[0];
    const middle = cheapestSailingsByDuration[Math.floor(cheapestSailingsByDuration.length / 2)];
    const last = cheapestSailingsByDuration[cheapestSailingsByDuration.length - 1];
    return [first, middle, last];
}

function findCheapestItinerarySailing(metacode: string, itinerary: IItinerary): IItinerarySailing {
    let cheapestSailing: ISailing = null;
    let cheapestRoom: IRoom = null;
    itinerary.sailings.forEach((sailing: ISailing, index: number) => {
        var room = getRoom(metacode, sailing);
        if (!room.soldOut) {
            if (cheapestRoom == null || room.price < cheapestRoom.price) {
                cheapestSailing = sailing;
                cheapestRoom = room;
            }
        }
    });

    return { sailing: cheapestSailing, room: cheapestRoom, itinerary: itinerary };
}

function getRoom(metacode: string, sailing: ISailing) {
    switch (metacode) {
        case "IS":
        case "UL":
            //interior
            return sailing.rooms.interior;
        case "OS":
            //oceanview
            return sailing.rooms.oceanview;
        case "OB":
            //balcony
            return sailing.rooms.balcony;
        case "SU":
            //suite
            return sailing.rooms.suite;
        default:
            throw "unknown meta: " + metacode;
    }
}